<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Sign in | Early Learning Family Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --brand-blue:#01689b; --ink:#161c24; --muted:#6b7280; --panel-bg:#f6f8fb;
        --card:#fff; --border:#e6e9ef; --radius:12px; --focus:0 0 0 3px rgba(1,104,155,0.2);
      }
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:"Segoe UI", Roboto, Arial, sans-serif;color:var(--ink);background:var(--panel-bg)}
  a{color:var(--brand-blue);text-decoration:none}
  /* no underline on hover for buttons/links */
  a:hover{text-decoration:none}

      /* Shell */
      .shell{min-height:100dvh;display:grid;grid-template-columns:60% 40%;grid-template-areas:"image api"}
      .image-panel{grid-area:image;background-color:#fff;background-image:url('https://sts.fldoesso.org/adfs/portal/illustration/illustration.png');background-repeat:no-repeat;background-position:right top;background-size:cover}
      .api-panel{grid-area:api;padding:40px 36px;display:flex;flex-direction:column;align-items:stretch;overflow-y:auto;background:linear-gradient(180deg, #ffffff 0%, #fbfcfe 100%)}

      .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
      .brand{display:flex;gap:12px;align-items:center}
      .brand__logo{width:44px;height:44px;border-radius:8px;background:#e9f4fb;color:var(--brand-blue);display:grid;place-items:center;font-weight:800}
      .brand__name{font-weight:700;color:var(--brand-blue)}

      .form-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:0 10px 30px rgba(16,24,40,0.06)}
      h1{margin:0 0 6px;font-size:22px}
      .lede{color:var(--muted);margin:0 0 16px}

      /* IdP buttons */
      .idp-list{display:grid;gap:12px;margin:16px 0}
      .idp-btn{display:grid;grid-template-columns:56px 1fr auto;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;text-decoration:none;color:var(--ink)}
      .idp-btn:hover{box-shadow:0 8px 26px rgba(16,24,40,0.06);transform:translateY(-2px)}
  .idp-icon{width:56px;height:56px;border-radius:8px;display:grid;place-items:center;color:#fff;font-weight:800;overflow:hidden}
  .idp-icon img{width:100%;height:100%;object-fit:contain;display:block}
      .idp-fdoe{background:#0f4473}
      .idp-flwins{background:#01689b}
      .idp-text{display:flex;flex-direction:column}
      .idp-title{font-weight:700}
      .idp-sub{color:var(--muted);font-size:13px}

      .local-form{margin-top:14px;border-top:1px dashed var(--border);padding-top:14px}
      .field{display:flex;flex-direction:column;margin-bottom:12px}
      label{font-size:13px;margin-bottom:6px;color:var(--muted)}
      input[type="text"],input[type="email"],input[type="password"]{padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:15px}
      input:focus{outline:none;box-shadow:var(--focus)}

      .actions{display:flex;gap:12px;margin-top:12px}
      .btn{display:inline-block;padding:10px 14px;border-radius:10px;font-weight:700;border:none;cursor:pointer}
      .btn-primary{background:var(--brand-blue);color:#fff}
      .btn-ghost{background:#fff;border:1px solid var(--border);color:var(--ink)}

      .support{margin-top:12px;color:var(--muted);font-size:13px}

      @media (max-width:900px){.shell{grid-template-columns:50% 50%}.image-panel{background-position:center top}}
      @media (max-width:640px){.shell{grid-template-columns:0% 100%}.image-panel{display:none}.api-panel{padding:28px}}
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="image-panel" aria-hidden="true"></div>

      <section class="api-panel" role="main" aria-label="Sign in panel">
        <div class="panel-header">
          <div class="brand" aria-label="Application">
            <div class="brand__logo" aria-hidden="true">EL</div>
            <div class="brand__name">Early Learning Family Portal</div>
          </div>
          <div>
            <ul class="nav-actions" id="nav-actions">
              <li><a href="index.html" class="btn btn-ghost" style="padding:8px 12px;border-radius:8px;font-weight:600">Back</a></li>
            </ul>
          </div>
        </div>

        <div class="form-card" aria-labelledby="signin-heading">
          <h1 id="signin-heading">Sign in</h1>
          <p class="lede">Choose a sign-in method to continue.</p>

          <div class="idp-list" role="list">
            <a class="idp-btn" role="listitem" href="https://efsmoddev.ciamlogin.com/a4b91259-0be5-4baa-b3f9-11d07cd913e8/oauth2/v2.0/authorize?response_type=code+id_token&redirect_uri=https%3A%2F%2Fefsmod2-dev-f4dsd9ffbegededq.canadacentral-01.azurewebsites.net%2F.auth%2Flogin%2Faad%2Fcallback&client_id=f2b62959-157c-4b41-a666-e473118a1e77&scope=openid+profile+email&response_mode=form_post&nonce=1992ddc2856941d3a04b5092fba71685_20251030202332&state=redir%3D%2Findex.html" aria-label="Self-registered users">
              <div class="idp-icon" aria-hidden="true"><img src="../public/images/localsts.png" alt="Self registered users icon"/></div>
              <div class="idp-text"><span class="idp-title">Self-registered users</span><span class="idp-sub">Sign in with your portal username & password</span></div>
              <div aria-hidden="true">→</div>
            </a>

            <a class="idp-btn" role="listitem" href="#" aria-label="Sign in with Florida Department of Education">
              <div class="idp-icon" aria-hidden="true"><img src="../public/images/Florida_Department_of_Education.png" alt="Florida Department of Education logo"/></div>
              <div class="idp-text"><span class="idp-title">Florida Department of Education</span><span class="idp-sub">Sign in with your FLDOE SSO account</span></div>
              <div aria-hidden="true">→</div>
            </a>


      <!-- FLWINS via EFSMOD CIAM user flow: uses EFSMOD tenant domain and preselects external IdP so only one login occurs.
        Policy used: signup-signin-efsmod. Ensure that this user flow has FLWINS configured as an Identity Provider.
        Ensure client_id below is the EFSMOD app registration (not the FLWINS tenant app). -->
            <a class="idp-btn" role="listitem" href="/.auth/login/FLWINS?post_login_redirect_uri=/index.html" aria-label="Sign in with FLWINS">
              <div class="idp-icon" aria-hidden="true"><img src="../public/images/FLWINSssologo.png" alt="FLWINS logo"/></div>
              <div class="idp-text"><span class="idp-title">FLWINS</span><span class="idp-sub">Sign in using your FLWINS account</span></div>
              <div aria-hidden="true">→</div>
            </a>
          </div>
        </div>
      </section>
    </div>
    <script>
      (function(){
        async function isAuthenticated(){
          try{const r=await fetch('/.auth/me',{credentials:'include'}); if(!r.ok) return false; const j=await r.json(); return Array.isArray(j)&&j.length>0?j[0]:false;}catch(e){return false}
        }
        function clearClientStorage(){try{localStorage.clear();sessionStorage.clear();}catch(e){} document.cookie.split(';').forEach(function(c){var name=c.split('=')[0].trim(); if(!name) return; document.cookie = name+'=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';});}
        function signOut(){ clearClientStorage(); window.location.href = '/.auth/logout?post_logout_redirect_uri=/index.html'; }
        document.addEventListener('DOMContentLoaded', async function(){ var nav=document.getElementById('nav-actions'); if(!nav) return; var user=await isAuthenticated(); if(user){ nav.innerHTML = '<li><button id="signout" class="btn btn-ghost">Sign Out</button></li>'; document.getElementById('signout').addEventListener('click', signOut); } });
      })();
    </script>
    <script>
      // Dynamic redirect_uri only for anchors marked with data-dynamic-redirect.
      // This avoids repeated mutation and unintended double-encoding of state.
      (function(){
        function updateIdpLinks(){
          const origin = window.location.origin;
          const callback = origin + '/.auth/login/aad/callback';
          const anchors = document.querySelectorAll('a[data-dynamic-redirect="true"]');
          anchors.forEach(a => {
            try{
              const url = new URL(a.href);
              url.searchParams.set('redirect_uri', callback);
              // Do NOT touch state here to prevent double-encoding; ensure initial state is single-encoded in markup.
              // Replace TEMP_NONCE with a generated nonce each page load if hybrid/id_token needed.
              if(url.searchParams.get('nonce') === 'TEMP_NONCE'){
                const nonce = 'nonce_' + Math.random().toString(36).slice(2) + Date.now();
                url.searchParams.set('nonce', nonce);
              }
              a.href = url.toString();
            }catch(e){}
          });
        }
        if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', updateIdpLinks); else updateIdpLinks();
      })();
    </script>
  </body>
</html>
